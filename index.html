<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="css/style.css">

	<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/chance/1.0.18/chance.min.js"></script>

	<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
	<title>Thanos Snap</title>
</head>
<body>
	<div class="navbar">
		<span>Thanos'Snap Effect Tutorial</span>
	</div>

	<div class="wrapper">
		<div class="content">
			<img src="images/burger.png" alt="burger" width="500">
			<button id="start-btn">Snap!</button>
		</div>
	</div>
	<script>
		let imageDataArray = [];

		let canvasCount = 35;

		$('#start-btn').click(function(){
			html2canvas($('.content')[0]).then(canvas =>{
				ctx = canvas.getContext('2d');
				let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
				let pixelArr = imageData.data;

				createBlankImageData(imageData);

				// Put the pixel info of imageDataArray into a weighted Distribution
				for (let i = 0; i < pixelArr.length; i+=4) {
					//Find the highest probability that canvas should be in
					let p = Math.floor((i/pixelArr.length) * canvasCount);

					let a = imageDataArray[weightedRandomDistrib(p)];
					a[i] = pixelArr[i];
					a[i+1] = pixelArr[i+1];
					a[i+2] = pixelArr[i+2];
					a[i+3] = pixelArr[i+3];
				}

				//Create canvas for each imageData and append to target element
				for(let i = 0; i < canvasCount; i++){
					let c = newCanvasFromImageData(imageDataArray[i], canvas.width, canvas.height);
					c.classList.add('dust');
					$('.wrapper').append(c);
				}

				//Clear all children except the canvas
				$('.content').children().not('dust').fadeOut(3500);

				//Apply animation
				$('.dust').each(function(index){
					animateBlur($(this), 0.8, 800);

					setTimeout(() =>{
						animateTransform( $(this), 100, -100, chance.integer({min:-15, max: 15 }), 800 + (110 * index) );
					}, 70 * index);

					// Remove the canvas from DOM tree when faded
					$(this).delay(70 * index).fadeOut( (110 * index) + 800, 'easeInQuint', () => {$(this).remove();} );
				});
			});
		});

		function weightedRandomDistrib(peak) {
			let prob = [], seq = [];

			for(let i = 0; i < canvasCount; i++){
				prob.push(Math.pow(canvasCount-Math.abs(peak-i), 3));
				seq.push(i);
			}

			return chance.weighted(seq, prob)
		}

		function animateBlur(elem, radius, duration) {
			var r = 0;
			$({rad:0}).animate({rad:radius},{
				duration : duration,
				easing: "easeOutQuad",
				step: function(now){
					elem.css({
						filter: 'blur(' + now + 'px)'
					});
				}
			})
		}

		function animateTransform(elem, sx, sy, angle, duration){
			let td = tx = ty = 0;
			$({x: 0, y:0, deg: 0}).animate({x: sx, y: sy, def: angle}, {
				duration: duration,
				easing: 'easeOutQuad',
				step: function(now, fx){

					if(fx.prop == 'x'){
						tx = now;
					}else if(fx.prop == 'y') {
						ty = now;
					}else if(fx.prop == 'deg') {
						td = now;
					}

					elem.css({
						transform: 'rotate(' + td + 'deg)' + 'translate(' + tx + 'px,' + ty + 'px)'
					});
				}
			})
		}

		function createBlankImageData(imageData) {
	      for(let i=0;i<canvasCount;i++)
	      {
	        let arr = new Uint8ClampedArray(imageData.data);
	        for (let j = 0; j < arr.length; j++) {
	            arr[j] = 0;
	        }
	        imageDataArray.push(arr);
	      }
	    }

	    function newCanvasFromImageData(imageDataArray ,w , h) {
	      var canvas = document.createElement('canvas');
	          canvas.width = w;
	          canvas.height = h;
	          tempCtx = canvas.getContext("2d");
	          tempCtx.putImageData(new ImageData(imageDataArray, w , h), 0, 0);
	          
	      return canvas;
	    }
	</script>
</body>
</html>